# Default values for github-actions-runners
# This chart creates GitHub Actions Runner Scale Sets

gha-runner-scale-set:
  # GitHub configuration
  githubConfigUrl: ""  # Required: https://github.com/org/repo
  runnerScaleSetName: ""  # Required: Name for the runner scale set

  # GitHub credentials
  githubConfigSecret:
    github_token: ""  # Required: GitHub PAT with repo permissions

  # Scaling configuration
  minRunners: 0
  maxRunners: 10

  # Runner configuration
  runnerGroup: "Default"

  # Container template
  template:
    spec:
      containers:
      - name: runner
        image: ghcr.io/actions/actions-runner:latest
        command:
        - /home/runner/run.sh
        env:
        - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
          value: "false"
        - name: ACTIONS_RUNNER_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        resources:
          requests:
            cpu: "1"
            memory: 2Gi
          limits:
            cpu: "2"
            memory: 4Gi
        volumeMounts:
        - name: work
          mountPath: /home/runner/_work

      restartPolicy: Never
      volumes:
      - name: work
        emptyDir:
          sizeLimit: 10Gi

# Configuration presets for different repository types
presets:
  # Frontend repository preset (Node.js/npm)
  frontend:
    enabled: false
    githubConfigUrl: "https://github.com/Matchpoint-AI/project-beta-frontend"
    runnerScaleSetName: "arc-frontend-runners"
    minRunners: 1
    maxRunners: 15
    template:
      spec:
        containers:
        - name: runner
          image: ghcr.io/actions/actions-runner:latest
          command:
          - /home/runner/run.sh
          env:
          - name: ACTIONS_RUNNER_LABELS
            value: "arc-frontend-runners,self-hosted,linux,x64"
          - name: RUNNER_NAME_PREFIX
            value: "arc-frontend"
          - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
            value: "false"
          - name: DOCKER_HOST
            value: "tcp://localhost:2375"
          - name: NODE_OPTIONS
            value: "--max-old-space-size=6144"
          - name: NPM_CONFIG_CACHE
            value: "/home/runner/_work/_npm-cache"
          resources:
            requests:
              cpu: "2"
              memory: 4Gi
            limits:
              cpu: "3"
              memory: 6Gi
          volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: npm-cache
            mountPath: /home/runner/_work/_npm-cache
          - name: docker-certs
            mountPath: /certs/client
            readOnly: true
        - name: dind
          image: docker:24-dind
          command:
          - dockerd
          args:
          - --host=tcp://0.0.0.0:2375
          - --storage-driver=overlay2
          env:
          - name: DOCKER_TLS_CERTDIR
            value: ""
          resources:
            requests:
              cpu: "1"
              memory: 2Gi
            limits:
              cpu: "2"
              memory: 4Gi
          securityContext:
            privileged: true
          volumeMounts:
          - name: docker-storage
            mountPath: /var/lib/docker
          - name: docker-certs
            mountPath: /certs/client
        volumes:
        - name: work
          emptyDir:
            sizeLimit: 25Gi
        - name: npm-cache
          emptyDir:
            sizeLimit: 10Gi
        - name: docker-storage
          emptyDir:
            sizeLimit: 20Gi
        - name: docker-certs
          emptyDir: {}

  # API repository preset (Python/Docker)
  api:
    enabled: false
    githubConfigUrl: "https://github.com/Matchpoint-AI/project-beta-api"
    runnerScaleSetName: "arc-api-runners-v2"
    minRunners: 1
    maxRunners: 15
    template:
      spec:
        containers:
        - name: runner
          image: ghcr.io/actions/actions-runner:latest
          command:
          - /home/runner/run.sh
          env:
          - name: ACTIONS_RUNNER_LABELS
            value: "arc-api-runners-v2,self-hosted,linux,x64"
          - name: RUNNER_NAME_PREFIX
            value: "arc-api"
          - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
            value: "false"
          - name: DOCKER_HOST
            value: "tcp://localhost:2375"
          resources:
            requests:
              cpu: "2"
              memory: 4Gi
            limits:
              cpu: "3"
              memory: 6Gi
          volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: docker-certs
            mountPath: /certs/client
            readOnly: true
        - name: dind
          image: docker:24-dind
          command:
          - dockerd
          args:
          - --host=tcp://0.0.0.0:2375
          - --storage-driver=overlay2
          env:
          - name: DOCKER_TLS_CERTDIR
            value: ""
          resources:
            requests:
              cpu: "1"
              memory: 2Gi
            limits:
              cpu: "2"
              memory: 4Gi
          securityContext:
            privileged: true
          volumeMounts:
          - name: docker-storage
            mountPath: /var/lib/docker
          - name: docker-certs
            mountPath: /certs/client
        volumes:
        - name: work
          emptyDir:
            sizeLimit: 20Gi
        - name: docker-storage
          emptyDir:
            sizeLimit: 10Gi
        - name: docker-certs
          emptyDir: {}

  # Beta repository preset (Python with persistent storage)
  beta:
    enabled: false
    githubConfigUrl: "https://github.com/Matchpoint-AI/project-beta"
    runnerScaleSetName: "arc-beta-runners-new"
    minRunners: 0
    maxRunners: 20
    template:
      spec:
        containers:
        - name: runner
          image: ghcr.io/actions/actions-runner:latest
          command:
          - /home/runner/run.sh
          env:
          - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
            value: "false"
          - name: ACTIONS_RUNNER_POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: NODE_OPTIONS
            value: "--max-old-space-size=4096"
          - name: PYTHONUNBUFFERED
            value: "1"
          - name: PIP_CACHE_DIR
            value: "/home/runner/_work/_pip-cache"
          resources:
            requests:
              cpu: 2000m
              memory: 4Gi
            limits:
              cpu: 4000m
              memory: 8Gi
          volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: build-cache
            mountPath: /home/runner/_work/_cache
        volumes:
        - name: work
          ephemeral:
            volumeClaimTemplate:
              spec:
                accessModes:
                - ReadWriteOnce
                resources:
                  requests:
                    storage: 35Gi
                storageClassName: standard-rwo
        - name: build-cache
          emptyDir:
            sizeLimit: 15Gi