# Values file for Matchpoint Organization-level runners
# Deploy with: helm install arc-runners ./charts/github-actions-runners -f examples/runners-values.yaml

gha-runner-scale-set:
  # Controller service account configuration
  controllerServiceAccount:
    namespace: arc-systems
    name: arc-gha-rs-controller
  # Organization-level runner to serve all repos (project-beta, project-beta-api, project-beta-frontend)
  githubConfigUrl: "https://github.com/Matchpoint-AI"
  runnerScaleSetName: "arc-beta-runners"  # GitHub label for runs-on (standardized per Issue #889)

  # Reference pre-defined secret with org-level PAT (created manually in cluster)
  # Secret must be created with: kubectl create secret generic arc-org-github-secret --namespace=arc-runners --from-literal=github_token='ghp_...'
  githubConfigSecret: arc-org-github-secret

  # Scaling configuration - tuned for capacity (Issues #152, #154)
  # Resource math: Each pod needs 3 CPU (runner: 2, dind: 1)
  # With 15 max nodes × 7.5 CPU = 112 CPU → ~30 max concurrent runners
  # Keep minRunners warm to eliminate cold start delays (2-5 min → <10 sec)
  minRunners: 5      # 5 warm runners for instant job pickup (Issue #152)
  maxRunners: 25     # Allow scaling to 25 for peak demand (Issue #154)

  # Security context for beta runners - removed to allow runner to work properly
  # securityContext:
  #   fsGroup: 123

  template:
    spec:
      containers:
      - name: runner
        image: ghcr.io/matchpoint-ai/arc-runner:latest
        imagePullPolicy: IfNotPresent  # Faster startup
        command:
        - /home/runner/run.sh
        env:
        # NOTE: ACTIONS_RUNNER_LABELS does not work with ARC
        # ARC only uses runnerScaleSetName as the GitHub label
        # See: https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners-with-actions-runner-controller/using-actions-runner-controller-runners-in-a-workflow
        - name: RUNNER_NAME_PREFIX
          value: "arc-beta"
        - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
          value: "false"
        - name: DOCKER_HOST
          value: "tcp://localhost:2375"
        - name: DOCKER_API_VERSION
          value: "1.43"  # Required: DinD v24 max API is 1.43, runner Docker client v29 uses 1.52
        - name: ACTIONS_RUNNER_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NODE_OPTIONS
          value: "--max-old-space-size=10240"  # Increased for ARC performance (Issue #1522)
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: PIP_CACHE_DIR
          value: "/home/runner/_work/_pip-cache"
        resources:
          # Reduced to allow 2 pods per node (Issue #141)
          # Node capacity: 7.5 CPU allocatable - 2 pods × 3 CPU = 6 CPU, leaving 1.5 CPU for system
          # Trade-off: Slightly slower CI but better scheduling and concurrency
          requests:
            cpu: "2"        # Reduced from 4 for better pod density
            memory: 8Gi     # Reduced from 12Gi for better scheduling
          limits:
            cpu: "3"        # Allow burst to 3 CPU
            memory: 10Gi
        volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: docker-certs
          mountPath: /certs/client
          readOnly: true
      - name: dind
        image: docker:24-dind
        command:
        - dockerd
        args:
        - --host=tcp://0.0.0.0:2375
        - --storage-driver=overlay2
        env:
        - name: DOCKER_TLS_CERTDIR
          value: ""
        resources:
          # DinD sidecar - reduced for better pod density (Issue #141)
          # Still sufficient for Docker builds and testcontainers
          requests:
            cpu: "1"        # Reduced from 2 for better scheduling
            memory: 3Gi     # Reduced from 4Gi
          limits:
            cpu: "2"        # Allow burst for heavy builds
            memory: 6Gi
        securityContext:
          privileged: true
        volumeMounts:
        - name: docker-storage
          mountPath: /var/lib/docker
        - name: docker-certs
          mountPath: /certs/client
      restartPolicy: Never
      volumes:
      - name: work
        emptyDir:
          sizeLimit: 25Gi
      - name: docker-storage
        emptyDir:
          sizeLimit: 20Gi
      - name: docker-certs
        emptyDir: {}
