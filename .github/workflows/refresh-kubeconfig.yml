name: Refresh Kubeconfig Token

# Rackspace Spot kubeconfig tokens expire after 3 days.
# This workflow refreshes the token every 2 days to ensure it never expires.
# The refreshed token is stored in terraform state (tfstate.dev).
#
# To get a fresh kubeconfig locally:
#   export TF_HTTP_PASSWORD=$(gh auth token)
#   cd terraform && terraform init && terraform output -raw kubeconfig_raw > /tmp/kubeconfig.yaml

on:
  schedule:
    # Run every 2 days at 6 AM UTC (well before 3-day expiration)
    - cron: '0 6 */2 * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual refresh'
        required: false
        default: 'Manual refresh requested'

permissions:
  contents: read

jobs:
  refresh-token:
    name: Refresh Terraform State
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '~> 1.5'

      - name: Terraform Init
        working-directory: terraform
        env:
          TF_HTTP_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: terraform init -input=false

      - name: Terraform Refresh
        working-directory: terraform
        env:
          TF_HTTP_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
          TF_VAR_rackspace_spot_token: ${{ secrets.RACKSPACE_SPOT_API_TOKEN }}
          TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Refreshing terraform state to get new kubeconfig token..."
          # Only refresh the cloudspace module to avoid provider circular dependency
          # The kubeconfig token is retrieved via data.spot_kubeconfig in the cloudspace module
          # We don't need to refresh Helm/Kubernetes resources (which depend on cloudspace outputs)
          terraform refresh -target=module.cloudspace -input=false
          echo "State refreshed successfully."

      - name: Verify Token Refresh
        working-directory: terraform
        env:
          TF_HTTP_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract and decode the new token to verify expiration
          echo "Verifying new token expiration..."
          KUBECONFIG_RAW=$(terraform output -raw kubeconfig_raw 2>/dev/null || echo "")

          if [ -z "$KUBECONFIG_RAW" ]; then
            echo "::error::Failed to get kubeconfig from terraform output"
            exit 1
          fi

          # Extract token from kubeconfig and decode JWT expiration
          TOKEN=$(echo "$KUBECONFIG_RAW" | grep -A1 "name: ngpc-user" | grep "token:" | sed 's/.*token: //' | tr -d ' ')

          if [ -n "$TOKEN" ]; then
            # Decode JWT payload (middle part)
            PAYLOAD=$(echo "$TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null || echo "{}")
            EXP=$(echo "$PAYLOAD" | jq -r '.exp // empty' 2>/dev/null || echo "")

            if [ -n "$EXP" ]; then
              EXP_DATE=$(date -d "@$EXP" 2>/dev/null || date -r "$EXP" 2>/dev/null || echo "unknown")
              echo "New token expires at: $EXP_DATE"
              echo "::notice::Kubeconfig token refreshed. New expiration: $EXP_DATE"
            else
              echo "::warning::Could not decode token expiration"
            fi
          else
            echo "::warning::Could not extract token from kubeconfig"
          fi

          echo "Kubeconfig refresh complete."

      - name: Summary
        run: |
          echo "## Kubeconfig Token Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform state refreshed with new kubeconfig token" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Token Validity:** 3 days from now" >> $GITHUB_STEP_SUMMARY
          echo "**Next Refresh:** In 2 days (before expiration)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Use" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'export TF_HTTP_PASSWORD=$(gh auth token)' >> $GITHUB_STEP_SUMMARY
          echo 'cd terraform && terraform init' >> $GITHUB_STEP_SUMMARY
          echo 'terraform output -raw kubeconfig_raw > /tmp/kubeconfig.yaml' >> $GITHUB_STEP_SUMMARY
          echo 'export KUBECONFIG=/tmp/kubeconfig.yaml' >> $GITHUB_STEP_SUMMARY
          echo 'kubectl get nodes' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
